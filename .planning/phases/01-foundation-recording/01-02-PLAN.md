---
phase: 01-foundation-recording
plan: 02
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src-tauri/src/lib.rs
  - src-tauri/src/tray.rs
  - src-tauri/src/shortcuts.rs
  - src-tauri/src/state.rs
  - src-tauri/src/sounds.rs
  - src-tauri/tauri.conf.json
  - src/stores/app-store.ts
  - src/windows/FloatingBar.tsx
  - src/hooks/useRecordingState.ts
autonomous: true

must_haves:
  truths:
    - "User sees TTP icon in system tray/menu bar"
    - "User can hold Ctrl+Shift+Space to show recording state"
    - "User can double-tap Ctrl+Shift+Space to toggle persistent recording mode"
    - "User sees floating bar appear when recording starts"
    - "Floating bar disappears when recording stops"
    - "Sound plays when recording starts and stops"
  artifacts:
    - path: "src-tauri/src/tray.rs"
      provides: "System tray setup with context menu"
      contains: "TrayIconBuilder"
    - path: "src-tauri/src/shortcuts.rs"
      provides: "Global shortcut handling with press/release detection"
      contains: "ShortcutState::Pressed"
    - path: "src-tauri/src/state.rs"
      provides: "Recording state machine"
      contains: "enum RecordingState"
    - path: "src/windows/FloatingBar.tsx"
      provides: "Transparent floating recording indicator"
      min_lines: 30
    - path: "src/hooks/useRecordingState.ts"
      provides: "Frontend hook for recording state events"
      contains: "listen.*recording-state-changed"
  key_links:
    - from: "src-tauri/src/shortcuts.rs"
      to: "src-tauri/src/state.rs"
      via: "shortcut handler calls state machine"
      pattern: "set_state\\(RecordingState"
    - from: "src-tauri/src/state.rs"
      to: "src/hooks/useRecordingState.ts"
      via: "Tauri event emission"
      pattern: "emit.*recording-state-changed"
    - from: "src-tauri/src/shortcuts.rs"
      to: "src-tauri/src/sounds.rs"
      via: "play sound on state change"
      pattern: "play_.*_sound"
---

<objective>
Build the system tray app with global keyboard shortcuts and recording state machine.

Purpose: Establish the core interaction model - user presses shortcut, app responds with visual/audio feedback and state changes. This is the primary UX for the entire application.

Output: Tray-resident app that responds to Ctrl+Shift+Space with push-to-talk and double-tap toggle modes, visual floating bar, and audio cues.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-recording/01-RESEARCH.md
@.planning/phases/01-foundation-recording/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement recording state machine and tray icon</name>
  <files>
    src-tauri/src/state.rs
    src-tauri/src/tray.rs
    src-tauri/src/lib.rs
    src-tauri/tauri.conf.json
  </files>
  <action>
    1. Create src-tauri/src/state.rs with AppState struct:
       ```rust
       use tauri::{AppHandle, Emitter};
       use serde::{Serialize, Deserialize};
       use std::time::Instant;

       #[derive(Clone, Serialize, Deserialize, Debug, PartialEq)]
       pub enum RecordingState {
           Idle,
           Recording,
           Processing,
       }

       pub struct AppState {
           pub recording_state: RecordingState,
           pub hands_free_mode: bool,
           pub last_shortcut_time: Option<Instant>,
       }

       impl Default for AppState {
           fn default() -> Self {
               Self {
                   recording_state: RecordingState::Idle,
                   hands_free_mode: false,
                   last_shortcut_time: None,
               }
           }
       }

       impl AppState {
           pub fn set_state(&mut self, state: RecordingState, app: &AppHandle) {
               self.recording_state = state.clone();
               app.emit("recording-state-changed", &state).ok();
           }
       }
       ```

    2. Create src-tauri/src/tray.rs with system tray setup:
       - Use TrayIconBuilder to create tray icon
       - Create context menu with "Settings..." and "Quit" items
       - Handle menu events (quit exits app, settings will open settings window)
       - Load icon-idle.png as initial icon
       - Add function to swap to icon-recording.png when recording starts

    3. Update tauri.conf.json:
       - Add floating-bar window configuration:
         - label: "floating-bar"
         - width: 200, height: 50
         - decorations: false, transparent: true
         - alwaysOnTop: true, skipTaskbar: true
         - visible: false (starts hidden)
         - resizable: false
       - Set main window to start hidden (tray-only app)

    4. Update src-tauri/src/lib.rs:
       - Declare state and tray modules
       - Add AppState as managed state wrapped in Mutex
       - Call tray::setup_tray in setup hook

    AVOID: Do not use Tauri 1.x SystemTray API. Use Tauri 2.x tray::TrayIconBuilder.
    AVOID: Do not block the main thread with Mutex locks - use try_lock or spawn_blocking.
  </action>
  <verify>
    - `cargo check --manifest-path src-tauri/Cargo.toml` passes
    - `npm run tauri dev` shows icon in system tray
    - Right-click tray icon shows context menu
    - "Quit" menu item exits the application
  </verify>
  <done>
    - Tray icon visible in system tray
    - Context menu functional with Settings and Quit
    - AppState struct manages recording state
    - State changes emit events to frontend
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement global shortcuts with push-to-talk and double-tap</name>
  <files>
    src-tauri/src/shortcuts.rs
    src-tauri/src/sounds.rs
    src-tauri/src/lib.rs
    src-tauri/sounds/start.wav
    src-tauri/sounds/stop.wav
  </files>
  <action>
    1. Create src-tauri/src/shortcuts.rs:
       - Register Ctrl+Shift+Space as global shortcut
       - Use tauri_plugin_global_shortcut with handler that receives ShortcutState
       - Implement double-tap detection with 300ms threshold:
         ```rust
         const DOUBLE_TAP_THRESHOLD_MS: u128 = 300;

         fn handle_shortcut_pressed(state: &mut AppState, app: &AppHandle) {
             let now = Instant::now();
             let is_double_tap = state.last_shortcut_time
                 .map(|last| now.duration_since(last).as_millis() < DOUBLE_TAP_THRESHOLD_MS)
                 .unwrap_or(false);
             state.last_shortcut_time = Some(now);

             if is_double_tap {
                 // Toggle hands-free mode
                 match state.recording_state {
                     RecordingState::Idle => {
                         state.hands_free_mode = true;
                         start_recording(state, app);
                     }
                     RecordingState::Recording if state.hands_free_mode => {
                         stop_recording(state, app);
                         state.hands_free_mode = false;
                     }
                     _ => {}
                 }
             } else {
                 // Push-to-talk: start on press
                 if matches!(state.recording_state, RecordingState::Idle) {
                     state.hands_free_mode = false;
                     start_recording(state, app);
                 }
             }
         }

         fn handle_shortcut_released(state: &mut AppState, app: &AppHandle) {
             // Only stop if push-to-talk (not hands-free)
             if !state.hands_free_mode && matches!(state.recording_state, RecordingState::Recording) {
                 stop_recording(state, app);
             }
         }
         ```

       - start_recording: sets state to Recording, shows floating bar, plays start sound
       - stop_recording: sets state to Idle, hides floating bar, plays stop sound

    2. Create src-tauri/src/sounds.rs:
       - Add rodio dependency to Cargo.toml if not present:
         `rodio = { version = "0.19", default-features = false, features = ["wav"] }`
       - Implement play_sound(app: &AppHandle, sound_name: &str)
       - Use separate thread for audio playback to avoid blocking
       - Functions: play_start_sound(), play_stop_sound()

    3. Add sound effect files:
       - Create/download simple WAV files for start and stop sounds
       - Place in src-tauri/sounds/start.wav and src-tauri/sounds/stop.wav
       - Keep sounds short (< 0.5 seconds) and subtle
       - If unable to source sounds, create silent placeholder WAVs

    4. Update src-tauri/src/lib.rs:
       - Declare shortcuts and sounds modules
       - Register global shortcut plugin in builder
       - Call shortcuts::setup_shortcuts in setup hook

    5. Update src-tauri/tauri.conf.json bundle.resources:
       - Add "sounds/*" to include sound files in bundle

    AVOID: Do not use fn key - it cannot be captured on macOS.
    AVOID: Do not use synchronous audio playback - spawn thread.
  </action>
  <verify>
    - `npm run tauri dev` runs without errors
    - Hold Ctrl+Shift+Space: recording starts (logged to console)
    - Release Ctrl+Shift+Space: recording stops (logged to console)
    - Double-tap Ctrl+Shift+Space: enters hands-free mode (stays recording)
    - Tap again while hands-free: stops recording
    - Sound plays on start and stop
  </verify>
  <done>
    - Global shortcut Ctrl+Shift+Space registered
    - Push-to-talk mode works (hold to record, release to stop)
    - Double-tap toggle mode works (tap to start, tap to stop)
    - Audio cues play on state transitions
  </done>
</task>

<task type="auto">
  <name>Task 3: Create floating bar UI and frontend state hook</name>
  <files>
    src/windows/FloatingBar.tsx
    src/hooks/useRecordingState.ts
    src/stores/app-store.ts
    src/main.tsx
    src/index.css
  </files>
  <action>
    1. Create src/hooks/useRecordingState.ts:
       ```typescript
       import { listen } from '@tauri-apps/api/event';
       import { useState, useEffect } from 'react';

       type RecordingState = 'Idle' | 'Recording' | 'Processing';

       export function useRecordingState() {
         const [state, setState] = useState<RecordingState>('Idle');

         useEffect(() => {
           const unlisten = listen<RecordingState>('recording-state-changed', (event) => {
             setState(event.payload);
           });
           return () => { unlisten.then(fn => fn()); };
         }, []);

         return state;
       }
       ```

    2. Create src/stores/app-store.ts with Zustand:
       ```typescript
       import { create } from 'zustand';

       interface AppStore {
         hasApiKey: boolean;
         setHasApiKey: (value: boolean) => void;
       }

       export const useAppStore = create<AppStore>((set) => ({
         hasApiKey: false,
         setHasApiKey: (value) => set({ hasApiKey: value }),
       }));
       ```

    3. Create src/windows/FloatingBar.tsx:
       - Transparent background (bg-transparent)
       - Rounded pill shape with subtle background (bg-black/80 backdrop-blur)
       - Recording indicator: pulsing red dot + "Recording..." text
       - Use Tailwind for styling
       - Use Lucide's Mic icon
       - Animate presence (fade in/out) - use CSS transitions or simple state
       - Example layout:
         ```tsx
         <div className="flex items-center gap-2 px-4 py-2 rounded-full bg-black/80 backdrop-blur text-white">
           <span className="w-3 h-3 rounded-full bg-red-500 animate-pulse" />
           <Mic className="w-4 h-4" />
           <span className="text-sm font-medium">Recording...</span>
         </div>
         ```

    4. Update src/main.tsx to handle multiple windows:
       - Check current window label using WebviewWindow.getCurrent()
       - Render FloatingBar if label is "floating-bar"
       - Render main App otherwise
       - Example:
         ```tsx
         import { getCurrentWebviewWindow } from '@tauri-apps/api/webviewWindow';

         const currentWindow = getCurrentWebviewWindow();
         const windowLabel = currentWindow.label;

         if (windowLabel === 'floating-bar') {
           createRoot(document.getElementById('root')!).render(<FloatingBar />);
         } else {
           createRoot(document.getElementById('root')!).render(<App />);
         }
         ```

    5. Update src/index.css for floating bar transparency:
       - Add html, body { background: transparent; } for floating-bar window
       - Keep normal background for other windows

    6. Update Rust code to show/hide floating bar:
       - In shortcuts.rs start_recording:
         ```rust
         if let Some(window) = app.get_webview_window("floating-bar") {
             let _ = window.show();
             let _ = window.set_focus();
         }
         ```
       - In shortcuts.rs stop_recording:
         ```rust
         if let Some(window) = app.get_webview_window("floating-bar") {
             let _ = window.hide();
         }
         ```

    AVOID: Do not use complex animation libraries. CSS transitions suffice.
    AVOID: Do not make floating bar interactive (no buttons) - it's purely visual feedback.
  </action>
  <verify>
    - `npm run tauri dev` runs without errors
    - Press and hold Ctrl+Shift+Space: floating bar appears at screen center
    - Release shortcut: floating bar disappears
    - Floating bar shows pulsing red dot and "Recording..." text
    - Floating bar is transparent with backdrop blur
  </verify>
  <done>
    - Floating bar window configured in tauri.conf.json
    - FloatingBar.tsx renders recording indicator
    - useRecordingState hook receives state updates from Rust
    - Show/hide logic wired to recording state transitions
    - Visual design matches Wispr Flow aesthetic (pill shape, blur, pulse)
  </done>
</task>

</tasks>

<verification>
After all tasks complete:
1. Run `npm run tauri dev`
2. Verify tray icon appears in system tray/menu bar
3. Right-click tray icon - context menu appears with Settings and Quit
4. Hold Ctrl+Shift+Space - floating bar appears, start sound plays
5. Release - floating bar hides, stop sound plays
6. Double-tap Ctrl+Shift+Space - enters hands-free mode (bar stays)
7. Tap again - exits hands-free mode (bar hides)
8. Click Quit in tray menu - app exits
</verification>

<success_criteria>
- Tray icon visible and functional with context menu
- Push-to-talk mode: hold shortcut to record, release to stop
- Toggle mode: double-tap to start persistent recording, tap to stop
- Floating bar provides visual feedback during recording
- Sound effects provide audio feedback for state changes
- All state transitions emit events to frontend
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-recording/01-02-SUMMARY.md`
</output>
