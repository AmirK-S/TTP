---
phase: 04-platform-parity
plan: 02
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - src-tauri/Entitlements.plist
  - src-tauri/tauri.conf.json
  - .github/workflows/build.yml
  - .github/workflows/release.yml
autonomous: false

user_setup:
  - service: apple-developer
    why: "macOS code signing and notarization"
    env_vars:
      - name: APPLE_CERTIFICATE
        source: "Export .p12 from Keychain Access -> base64 encode"
      - name: APPLE_CERTIFICATE_PASSWORD
        source: "Password used when exporting .p12"
      - name: APPLE_SIGNING_IDENTITY
        source: "Certificate name, e.g., 'Developer ID Application: Your Name (TEAMID)'"
      - name: APPLE_ID
        source: "Apple ID email used for notarization"
      - name: APPLE_PASSWORD
        source: "App-specific password from appleid.apple.com"
      - name: APPLE_TEAM_ID
        source: "Team ID from Apple Developer portal"
    dashboard_config:
      - task: "Create Developer ID Application certificate"
        location: "developer.apple.com -> Certificates"
  - service: windows-signing
    why: "Windows code signing (optional, reduces SmartScreen warnings)"
    env_vars:
      - name: WINDOWS_CERTIFICATE
        source: "Base64-encoded PFX file"
      - name: WINDOWS_CERTIFICATE_PASSWORD
        source: "PFX password"
    dashboard_config:
      - task: "Purchase OV or EV code signing certificate"
        location: "DigiCert, Sectigo, or similar CA"

must_haves:
  truths:
    - "macOS app can be signed and notarized via CI"
    - "Windows installer includes WebView2 bootstrapper"
    - "GitHub release workflow produces downloadable artifacts"
    - "Signed macOS app doesn't crash due to missing entitlements"
  artifacts:
    - path: "src-tauri/Entitlements.plist"
      provides: "macOS entitlements for hardened runtime"
      contains: "com.apple.security.device.audio-input"
    - path: ".github/workflows/release.yml"
      provides: "Automated release workflow"
      contains: "APPLE_CERTIFICATE"
    - path: "src-tauri/tauri.conf.json"
      provides: "Bundle configuration with entitlements and WebView2"
      contains: "embedBootstrapper"
  key_links:
    - from: ".github/workflows/release.yml"
      to: "Entitlements.plist"
      via: "tauri.conf.json bundle.macOS.entitlements"
      pattern: "entitlements.*Entitlements.plist"
---

<objective>
Distribution preparation with code signing, notarization, and installer configuration

Purpose: Prepare the app for distribution to end users. This includes macOS code signing/notarization (required for Gatekeeper), Windows installer with WebView2 bootstrapper, and a release workflow that produces signed artifacts.

Output: Entitlements.plist for macOS hardened runtime, updated tauri.conf.json with bundle settings, and GitHub Actions release workflow with signing.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-platform-parity/04-RESEARCH.md

# Current CI setup
@.github/workflows/build.yml

# Bundle config
@src-tauri/tauri.conf.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create macOS Entitlements.plist and update bundle config</name>
  <files>
src-tauri/Entitlements.plist
src-tauri/tauri.conf.json
  </files>
  <action>
Create entitlements file and update tauri.conf.json for proper code signing.

**Create src-tauri/Entitlements.plist:**
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <!-- Required for microphone access with hardened runtime -->
    <key>com.apple.security.device.audio-input</key>
    <true/>
    <!-- Required for accessibility/keyboard simulation -->
    <key>com.apple.security.automation.apple-events</key>
    <true/>
</dict>
</plist>
```

**Update src-tauri/tauri.conf.json bundle section:**
```json
"bundle": {
  "active": true,
  "targets": "all",
  "icon": [...existing icons...],
  "macOS": {
    "entitlements": "./Entitlements.plist",
    "exceptionDomain": null,
    "frameworks": [],
    "providerShortName": null,
    "signingIdentity": null,
    "hardenedRuntime": true,
    "minimumSystemVersion": "10.15"
  },
  "windows": {
    "certificateThumbprint": null,
    "digestAlgorithm": "sha256",
    "timestampUrl": "http://timestamp.comodoca.com",
    "webviewInstallMode": {
      "type": "embedBootstrapper"
    }
  }
}
```

Key changes to tauri.conf.json:
1. Set entitlements to "./Entitlements.plist"
2. Add hardenedRuntime: true
3. Add minimumSystemVersion: "10.15" (Catalina, required for Tauri)
4. Add webviewInstallMode with embedBootstrapper for Windows (ensures WebView2 installs)
5. Add timestampUrl for Windows code signing timestamp
  </action>
  <verify>
Files exist:
- src-tauri/Entitlements.plist exists with audio-input entitlement
- tauri.conf.json has entitlements path and webviewInstallMode

`cd src-tauri && cargo build` still works (config is valid JSON)
  </verify>
  <done>Entitlements.plist created with audio-input permission, tauri.conf.json updated with macOS entitlements path, hardened runtime, and Windows WebView2 embedBootstrapper</done>
</task>

<task type="auto">
  <name>Task 2: Create release workflow for signed builds</name>
  <files>.github/workflows/release.yml</files>
  <action>
Create a new release workflow that builds signed artifacts when a version tag is pushed.

**Create .github/workflows/release.yml:**
```yaml
name: Release TTP

on:
  push:
    tags:
      - 'v*'

env:
  CARGO_TERM_COLOR: always

jobs:
  release:
    permissions:
      contents: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: macos-latest
            target: aarch64-apple-darwin
            args: --target aarch64-apple-darwin
          - platform: macos-latest
            target: x86_64-apple-darwin
            args: --target x86_64-apple-darwin
          - platform: windows-latest
            target: x86_64-pc-windows-msvc
            args: ""

    runs-on: ${{ matrix.platform }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Rust cache
        uses: swatinem/rust-cache@v2
        with:
          workspaces: src-tauri -> target

      - name: Install frontend dependencies
        run: npm ci

      # Windows certificate import
      - name: Import Windows Certificate
        if: matrix.platform == 'windows-latest' && env.WINDOWS_CERTIFICATE != ''
        env:
          WINDOWS_CERTIFICATE: ${{ secrets.WINDOWS_CERTIFICATE }}
          WINDOWS_CERTIFICATE_PASSWORD: ${{ secrets.WINDOWS_CERTIFICATE_PASSWORD }}
        run: |
          New-Item -ItemType directory -Path certificate
          Set-Content -Path certificate/tempCert.txt -Value $env:WINDOWS_CERTIFICATE
          certutil -decode certificate/tempCert.txt certificate/certificate.pfx
          Import-PfxCertificate -FilePath certificate/certificate.pfx -CertStoreLocation Cert:\CurrentUser\My -Password (ConvertTo-SecureString -String $env:WINDOWS_CERTIFICATE_PASSWORD -Force -AsPlainText)

      - name: Build and Release
        uses: tauri-apps/tauri-action@v0
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # macOS signing (only used if secrets are set)
          APPLE_CERTIFICATE: ${{ secrets.APPLE_CERTIFICATE }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_SIGNING_IDENTITY: ${{ secrets.APPLE_SIGNING_IDENTITY }}
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_PASSWORD: ${{ secrets.APPLE_PASSWORD }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
        with:
          tagName: ${{ github.ref_name }}
          releaseName: "TTP ${{ github.ref_name }}"
          releaseBody: "See the assets below for downloadable installers."
          releaseDraft: true
          prerelease: false
          args: ${{ matrix.args }}
          timeout: 90
```

Key features:
1. Triggers on version tags (v1.0.0, v0.1.0, etc.)
2. Builds for macOS ARM, macOS Intel, and Windows x64
3. macOS signing uses Apple environment variables (if secrets are set)
4. Windows signing uses certificate import (if secrets are set)
5. Creates GitHub release with draft status (review before publishing)
6. 90-minute timeout for notarization
7. Signing is optional - builds work without secrets, just won't be signed
  </action>
  <verify>
File .github/workflows/release.yml exists and is valid YAML.
GitHub Actions syntax: `npm install -g @action-validator/cli && action-validator .github/workflows/release.yml` (or manual review)
  </verify>
  <done>Release workflow created that builds signed macOS/Windows artifacts on version tag push, with optional code signing when secrets are configured</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Distribution configuration complete:
1. Entitlements.plist with audio-input permission for macOS hardened runtime
2. tauri.conf.json updated with entitlements path and Windows WebView2 bootstrapper
3. release.yml workflow for automated signed releases
  </what-built>
  <how-to-verify>
1. Review src-tauri/Entitlements.plist - should have com.apple.security.device.audio-input
2. Review src-tauri/tauri.conf.json bundle section - should have:
   - macOS.entitlements: "./Entitlements.plist"
   - macOS.hardenedRuntime: true
   - windows.webviewInstallMode.type: "embedBootstrapper"
3. Review .github/workflows/release.yml - should have:
   - Trigger on 'v*' tags
   - Matrix with macos-latest and windows-latest
   - Apple signing environment variables
   - tauri-apps/tauri-action with tagName

4. Test local build: `npm run tauri build`
   - On macOS: Should build .dmg (unsigned locally is fine)
   - On Windows: Should build .msi and .exe

5. (Optional) To test signed builds:
   - Configure GitHub secrets as documented in user_setup
   - Push a test tag: `git tag v0.1.0-test && git push origin v0.1.0-test`
   - Check Actions tab for release workflow
  </how-to-verify>
  <resume-signal>Type "approved" if configuration looks correct, or describe issues found</resume-signal>
</task>

</tasks>

<verification>
1. src-tauri/Entitlements.plist exists with required entitlements
2. src-tauri/tauri.conf.json has entitlements path and webviewInstallMode
3. .github/workflows/release.yml exists with proper structure
4. `npm run tauri build` succeeds locally (unsigned)
5. Human verified configuration is correct
</verification>

<success_criteria>
- Entitlements.plist enables microphone access in hardened runtime
- tauri.conf.json points to entitlements and embeds WebView2 bootstrapper
- Release workflow builds for macOS (ARM + Intel) and Windows
- Signing is optional (works without secrets, signs when secrets present)
- Ready for user to configure signing secrets and publish releases
- Requirements addressed: PLT-03 (distribution readiness)
</success_criteria>

<output>
After completion, create `.planning/phases/04-platform-parity/04-02-SUMMARY.md`
</output>
