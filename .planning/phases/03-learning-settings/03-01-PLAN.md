---
phase: 03-learning-settings
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/dictionary/mod.rs
  - src-tauri/src/dictionary/store.rs
  - src-tauri/src/dictionary/detection.rs
  - src-tauri/src/transcription/polish.rs
  - src-tauri/src/transcription/pipeline.rs
  - src-tauri/src/lib.rs
autonomous: true

must_haves:
  truths:
    - "User corrections within 10 seconds of paste are detected"
    - "Detected proper noun corrections are stored in dictionary"
    - "Future transcriptions include dictionary terms in polish prompt"
  artifacts:
    - path: "src-tauri/src/dictionary/mod.rs"
      provides: "Dictionary module exports"
      exports: ["DictionaryEntry", "get_dictionary", "add_entry", "delete_entry", "clear_dictionary"]
    - path: "src-tauri/src/dictionary/store.rs"
      provides: "JSON file persistence for dictionary"
      contains: "dictionary.json"
    - path: "src-tauri/src/dictionary/detection.rs"
      provides: "Correction detection logic"
      contains: "detect_correction"
  key_links:
    - from: "src-tauri/src/transcription/polish.rs"
      to: "dictionary/store.rs"
      via: "dictionary terms in system prompt"
      pattern: "get_dictionary"
    - from: "src-tauri/src/transcription/pipeline.rs"
      to: "dictionary/detection.rs"
      via: "start_correction_window after paste"
      pattern: "start_correction_window"
---

<objective>
Create the dictionary learning system that detects user corrections and stores them for future transcriptions.

Purpose: Enable TTP to learn from user corrections of proper nouns (names, places, specialized terms) and improve future transcription accuracy.

Output: Backend dictionary module with persistence, correction detection, and polish prompt integration.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-learning-settings/03-CONTEXT.md
@src-tauri/src/transcription/polish.rs
@src-tauri/src/transcription/pipeline.rs
@src-tauri/src/lib.rs
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create dictionary storage module</name>
  <files>
    src-tauri/src/dictionary/mod.rs
    src-tauri/src/dictionary/store.rs
  </files>
  <action>
Create dictionary module with JSON file persistence:

1. Create `src-tauri/src/dictionary/mod.rs`:
   - Export DictionaryEntry struct: { original: String, correction: String, created_at: i64 }
   - Export store and detection submodules
   - Re-export public functions

2. Create `src-tauri/src/dictionary/store.rs`:
   - Store dictionary in `~/.config/ttp/dictionary.json` (use dirs crate for cross-platform)
   - Implement:
     - `get_dictionary() -> Vec<DictionaryEntry>` - load from file, return empty vec if not exists
     - `add_entry(original: &str, correction: &str) -> Result<(), String>` - append to file
     - `delete_entry(original: &str) -> Result<(), String>` - remove by original
     - `clear_dictionary() -> Result<(), String>` - delete file
   - Add `dirs = "5"` to Cargo.toml dependencies
   - Use serde_json for serialization (already in dependencies)
  </action>
  <verify>
cargo check --package ttp
  </verify>
  <done>Dictionary module compiles with all CRUD operations</done>
</task>

<task type="auto">
  <name>Task 2: Implement correction detection</name>
  <files>
    src-tauri/src/dictionary/detection.rs
    src-tauri/src/transcription/pipeline.rs
  </files>
  <action>
Create correction detection that monitors for edits after paste:

1. Create `src-tauri/src/dictionary/detection.rs`:
   - Implement correction detection using clipboard monitoring approach:
     - `start_correction_window(app: &AppHandle, pasted_text: String)` - starts a 10-second detection window
     - After 10 seconds, read clipboard content
     - If clipboard differs from pasted_text AND looks like a proper noun correction:
       - Extract the changed word (compare word-by-word)
       - Check if correction looks like proper noun (starts with capital, not at sentence start)
       - Call `add_entry(original_word, corrected_word)`
   - Use tokio::spawn for async timer
   - Focus detection on proper nouns only (per CONTEXT.md):
     - Names: capitalized words not at sentence start
     - Ignore punctuation/grammar changes
     - Ignore case-only changes at sentence start

2. Update `src-tauri/src/transcription/pipeline.rs`:
   - After successful paste (line ~159), call `start_correction_window(app, polished_text.clone())`
   - Import the detection module

Note: The detection is best-effort - clipboard may change for other reasons. Only clear proper noun substitutions should be learned.
  </action>
  <verify>
cargo check --package ttp
  </verify>
  <done>Correction detection compiles and is wired into pipeline</done>
</task>

<task type="auto">
  <name>Task 3: Integrate dictionary into polish prompt</name>
  <files>
    src-tauri/src/transcription/polish.rs
    src-tauri/src/lib.rs
  </files>
  <action>
Update polish to include dictionary terms and expose Tauri commands:

1. Update `src-tauri/src/transcription/polish.rs`:
   - Add function `build_polish_prompt(dictionary: &[DictionaryEntry]) -> String`:
     - Start with POLISH_SYSTEM_PROMPT constant
     - If dictionary is not empty, append section:
       ```
       PERSONAL DICTIONARY (use these exact spellings):
       - {original} -> {correction}
       - {original} -> {correction}
       ```
     - Return combined prompt
   - Update `polish_text()` to take optional dictionary parameter
   - Load dictionary at start of polish_text if not provided

2. Update `src-tauri/src/lib.rs`:
   - Add `mod dictionary;` declaration
   - Add Tauri commands to invoke_handler:
     - get_dictionary (returns Vec<DictionaryEntry>)
     - delete_dictionary_entry (takes original: String)
     - clear_dictionary
   - Create wrapper commands that call dictionary::store functions

3. Update `src-tauri/src/dictionary/mod.rs`:
   - Add #[tauri::command] attributes to functions that will be exposed
   - Or create separate command wrappers
  </action>
  <verify>
cargo build --package ttp && echo "Build successful"
  </verify>
  <done>
    - Polish prompt includes dictionary terms when dictionary is not empty
    - Tauri commands for dictionary CRUD are registered
    - cargo build succeeds
  </done>
</task>

</tasks>

<verification>
1. `cargo build --package ttp` succeeds without warnings
2. Dictionary file location is cross-platform compatible
3. Dictionary entries can be added, retrieved, and deleted
4. Polish prompt includes dictionary terms
5. Correction detection starts after successful paste
</verification>

<success_criteria>
- Dictionary persistence works (load/save to JSON file)
- Polish prompt includes dictionary terms for AI context
- Correction window starts after paste completes
- All Tauri commands registered for frontend access
</success_criteria>

<output>
After completion, create `.planning/phases/03-learning-settings/03-01-SUMMARY.md`
</output>
