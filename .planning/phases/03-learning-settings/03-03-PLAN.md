---
phase: 03-learning-settings
plan: 03
type: execute
wave: 2
depends_on: ["03-02"]
files_modified:
  - src-tauri/src/history/mod.rs
  - src-tauri/src/history/store.rs
  - src-tauri/src/transcription/pipeline.rs
  - src-tauri/src/lib.rs
  - src/windows/Settings.tsx
  - src/stores/settings-store.ts
autonomous: true

must_haves:
  truths:
    - "All transcriptions are saved with timestamps"
    - "User can view recent transcription history in settings"
    - "User can copy any past transcription to clipboard"
  artifacts:
    - path: "src-tauri/src/history/store.rs"
      provides: "History persistence"
      contains: "HistoryEntry"
    - path: "src/windows/Settings.tsx"
      provides: "History UI section"
      contains: "History"
  key_links:
    - from: "src-tauri/src/transcription/pipeline.rs"
      to: "history/store.rs"
      via: "save after successful transcription"
      pattern: "add_history_entry"
    - from: "src/windows/Settings.tsx"
      to: "src-tauri/src/history/store.rs"
      via: "Tauri invoke"
      pattern: "invoke.*get_history"
---

<objective>
Create transcription history system with storage and UI.

Purpose: Allow users to view and copy past transcriptions, providing a safety net for valuable dictations.

Output: History storage backend and History section in Settings UI.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-learning-settings/03-CONTEXT.md
@.planning/phases/03-learning-settings/03-02-SUMMARY.md
@src-tauri/src/transcription/pipeline.rs
@src-tauri/src/lib.rs
@src/windows/Settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create history storage module</name>
  <files>
    src-tauri/src/history/mod.rs
    src-tauri/src/history/store.rs
    src-tauri/src/transcription/pipeline.rs
    src-tauri/src/lib.rs
  </files>
  <action>
Create history module with persistence:

1. Create `src-tauri/src/history/mod.rs`:
   - Export HistoryEntry struct: { text: String, timestamp: i64, raw_text: Option<String> }
   - Export store submodule
   - Re-export public functions

2. Create `src-tauri/src/history/store.rs`:
   - Store history in `~/.config/ttp/history.json`
   - Implement:
     - `get_history() -> Vec<HistoryEntry>` - load from file, newest first
     - `add_history_entry(text: &str, raw_text: Option<&str>) -> Result<(), String>` - prepend to file
     - `clear_history() -> Result<(), String>` - delete file
   - Per CONTEXT.md: Keep all history (no limit)
   - Include timestamp as Unix epoch milliseconds

3. Update `src-tauri/src/transcription/pipeline.rs`:
   - Import history module
   - After successful transcription (before emit_progress "complete"):
     - Call `add_history_entry(&polished_text, Some(&raw_text))`
   - This saves every successful transcription with both polished and raw versions

4. Update `src-tauri/src/lib.rs`:
   - Add `mod history;`
   - Add Tauri commands: get_history, clear_history
  </action>
  <verify>
cargo check --package ttp
  </verify>
  <done>History module compiles, pipeline saves transcriptions to history</done>
</task>

<task type="auto">
  <name>Task 2: Add history UI to settings</name>
  <files>
    src/windows/Settings.tsx
    src/stores/settings-store.ts
  </files>
  <action>
Add history section to Settings UI:

1. Update `src/stores/settings-store.ts`:
   - Add history state: history: HistoryEntry[]
   - Add HistoryEntry type: { text: string, timestamp: number, raw_text?: string }
   - Add actions: loadHistory, clearHistory

2. Update `src/windows/Settings.tsx`:
   - Add **History** section after Dictionary section
   - Layout:
     - Header: "Transcription History" with "Clear History" button
     - List of history entries, each showing:
       - Timestamp (formatted: "Jan 29, 2:30 PM" or similar)
       - Text preview (first ~100 chars with ellipsis if longer)
       - Copy button (copies full text to clipboard)
     - Empty state: "No transcriptions yet"
   - Clear History button shows confirmation dialog before clearing
   - Use clipboard API to copy: `navigator.clipboard.writeText(entry.text)`
   - Load history on mount alongside settings and dictionary

3. Styling considerations:
   - History entries in a scrollable container (max-height)
   - Subtle alternating row colors for readability
   - Copy button uses clipboard icon from lucide-react
   - Timestamp in muted color, text in normal color
  </action>
  <verify>
npm run build && cargo build --package ttp
  </verify>
  <done>
    - History section appears in Settings
    - All past transcriptions listed with timestamps
    - Copy button works for each entry
    - Clear History removes all entries
  </done>
</task>

</tasks>

<verification>
1. `npm run build && cargo build --package ttp` succeeds
2. Transcriptions are saved to history after each successful transcription
3. History appears in Settings UI with timestamps
4. Copy button copies full text to clipboard
5. Clear History removes all entries with confirmation
6. History persists across app restarts
</verification>

<success_criteria>
- All transcriptions saved with timestamps
- History displayed in Settings UI
- Copy button works for any entry
- Clear History functional with confirmation
- History persists across restarts (no limit per CONTEXT.md)
</success_criteria>

<output>
After completion, create `.planning/phases/03-learning-settings/03-03-SUMMARY.md`
</output>
