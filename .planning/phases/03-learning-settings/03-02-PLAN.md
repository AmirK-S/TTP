---
phase: 03-learning-settings
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src-tauri/src/settings/mod.rs
  - src-tauri/src/settings/store.rs
  - src-tauri/src/transcription/pipeline.rs
  - src-tauri/src/tray.rs
  - src-tauri/src/lib.rs
  - src-tauri/tauri.conf.json
  - src/windows/Settings.tsx
  - src/stores/settings-store.ts
  - index.html
autonomous: true

must_haves:
  truths:
    - "User can access settings from tray menu"
    - "User can toggle AI polish on/off in settings"
    - "User can view and delete learned dictionary entries"
    - "User can reset all settings to defaults"
  artifacts:
    - path: "src-tauri/src/settings/store.rs"
      provides: "Settings persistence"
      contains: "ai_polish_enabled"
    - path: "src/windows/Settings.tsx"
      provides: "Settings UI component"
      min_lines: 80
    - path: "src/stores/settings-store.ts"
      provides: "Settings state management"
      exports: ["useSettingsStore"]
  key_links:
    - from: "src/windows/Settings.tsx"
      to: "src-tauri/src/settings/store.rs"
      via: "Tauri invoke commands"
      pattern: "invoke.*get_settings|set_settings"
    - from: "src-tauri/src/transcription/pipeline.rs"
      to: "settings/store.rs"
      via: "check ai_polish_enabled"
      pattern: "get_settings|ai_polish_enabled"
---

<objective>
Create settings UI with AI polish toggle and dictionary management.

Purpose: Allow users to configure TTP behavior and manage their learned dictionary entries.

Output: Settings window accessible from tray menu with AI polish toggle and dictionary table.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-learning-settings/03-CONTEXT.md
@src-tauri/src/tray.rs
@src-tauri/src/lib.rs
@src-tauri/tauri.conf.json
@src/App.tsx
@src/stores/app-store.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create settings backend module</name>
  <files>
    src-tauri/src/settings/mod.rs
    src-tauri/src/settings/store.rs
    src-tauri/src/transcription/pipeline.rs
    src-tauri/src/lib.rs
  </files>
  <action>
Create settings module with persistence and wire into pipeline:

1. Create `src-tauri/src/settings/mod.rs`:
   - Export Settings struct: { ai_polish_enabled: bool }
   - Export store submodule
   - Re-export public functions

2. Create `src-tauri/src/settings/store.rs`:
   - Store settings in `~/.config/ttp/settings.json`
   - Implement:
     - `get_settings() -> Settings` - load from file, return defaults if not exists
     - `set_settings(settings: Settings) -> Result<(), String>` - save to file
     - `reset_settings() -> Result<(), String>` - delete file (defaults apply)
   - Default settings: { ai_polish_enabled: true }

3. Update `src-tauri/src/transcription/pipeline.rs`:
   - Import settings module
   - In process_recording(), after transcription stage:
     - Load settings via get_settings()
     - If ai_polish_enabled is false, skip polish stage (use raw_text directly)
     - If ai_polish_enabled is true, proceed with polish as normal

4. Update `src-tauri/src/lib.rs`:
   - Add `mod settings;`
   - Add Tauri commands: get_settings, set_settings, reset_settings
  </action>
  <verify>
cargo check --package ttp
  </verify>
  <done>Settings module compiles, pipeline respects ai_polish_enabled flag</done>
</task>

<task type="auto">
  <name>Task 2: Create settings window and UI</name>
  <files>
    src-tauri/tauri.conf.json
    src-tauri/src/tray.rs
    src/windows/Settings.tsx
    src/stores/settings-store.ts
    index.html
  </files>
  <action>
Create settings window and wire up tray menu:

1. Update `src-tauri/tauri.conf.json`:
   - Add new window configuration for "settings":
     ```json
     {
       "label": "settings",
       "title": "TTP Settings",
       "width": 500,
       "height": 600,
       "resizable": true,
       "visible": false,
       "center": true,
       "decorations": true
     }
     ```

2. Update `src-tauri/src/tray.rs`:
   - Add "Settings..." menu item before "Quit"
   - On click, show the settings window (get_webview_window("settings").show())

3. Create `src/stores/settings-store.ts`:
   - Zustand store for settings state
   - State: { aiPolishEnabled: boolean, dictionary: DictionaryEntry[] }
   - Actions: loadSettings, saveSettings, loadDictionary, deleteEntry, clearDictionary

4. Create `src/windows/Settings.tsx`:
   - Single-page layout (no tabs per CONTEXT.md discretion - simpler)
   - Sections:
     a. **Transcription** section:
        - AI Polish toggle switch (on/off)
        - Description: "Clean up transcriptions with AI (remove filler words, fix grammar)"
     b. **Dictionary** section:
        - Table with columns: Original | Correction | Delete button
        - "Clear All" button with confirmation dialog
        - Empty state: "No learned corrections yet"
     c. **Reset** section:
        - "Reset to Defaults" button with confirmation
   - Use Tailwind for styling, match existing app aesthetic
   - Load settings on mount via invoke("get_settings")
   - Save settings immediately on toggle change

5. Update `index.html`:
   - Add route handling for settings window (check window label)
   - Render Settings component when label is "settings"
  </action>
  <verify>
npm run build && cargo build --package ttp
  </verify>
  <done>
    - Settings window opens from tray menu
    - AI polish toggle works and persists
    - Dictionary table displays entries with delete buttons
    - Clear All and Reset to Defaults work with confirmation
  </done>
</task>

</tasks>

<verification>
1. `npm run build && cargo build --package ttp` succeeds
2. Settings opens from tray menu "Settings..." item
3. AI polish toggle persists across app restarts
4. Disabling AI polish skips GPT-4o-mini call during transcription
5. Dictionary entries appear in table
6. Delete button removes individual entries
7. Clear All removes all entries with confirmation
8. Reset to Defaults restores ai_polish_enabled to true
</verification>

<success_criteria>
- Settings window accessible from tray menu
- AI polish toggle functional and persisted
- Dictionary management UI complete (view, delete, clear all)
- Reset to defaults works
- Pipeline respects AI polish setting
</success_criteria>

<output>
After completion, create `.planning/phases/03-learning-settings/03-02-SUMMARY.md`
</output>
