---
phase: 05-ensemble-transcription
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - src/stores/settings-store.ts
  - src/windows/Settings.tsx
autonomous: true

must_haves:
  truths:
    - "User can see ensemble mode toggle in settings UI"
    - "Toggle is disabled when fewer than 2 API keys are configured"
    - "UI shows which providers will be used when ensemble is enabled"
  artifacts:
    - path: "src/stores/settings-store.ts"
      provides: "Frontend state for ensemble_enabled"
      contains: "ensembleEnabled"
    - path: "src/windows/Settings.tsx"
      provides: "Ensemble mode toggle UI"
      contains: "Ensemble Mode"
  key_links:
    - from: "src/windows/Settings.tsx"
      to: "settings-store"
      via: "useSettingsStore hook"
      pattern: "useSettingsStore"
    - from: "src/stores/settings-store.ts"
      to: "backend settings"
      via: "invoke('set_settings')"
      pattern: "ensemble_enabled"
---

<objective>
Add frontend UI for ensemble mode toggle in settings window.

Purpose: Allow users to enable/disable ensemble transcription mode with clear feedback about provider requirements.
Output: Updated settings store with ensembleEnabled state, Settings.tsx with ensemble toggle UI.
</objective>

<execution_context>
@/Users/amirkellousidhoum/.claude/get-shit-done/workflows/execute-plan.md
@/Users/amirkellousidhoum/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-ensemble-transcription/05-RESEARCH.md
@.planning/phases/05-ensemble-transcription/05-01-SUMMARY.md

# Existing implementation
@src/stores/settings-store.ts
@src/windows/Settings.tsx
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ensemble_enabled to settings store</name>
  <files>src/stores/settings-store.ts</files>
  <action>
Update `src/stores/settings-store.ts`:

1. **Update Settings interface:**
```typescript
export interface Settings {
  ai_polish_enabled: boolean;
  shortcut: string;
  transcription_provider: TranscriptionProvider;
  ensemble_enabled: boolean;  // NEW
}
```

2. **Add ensembleEnabled to store state:**
```typescript
interface SettingsStore {
  // State
  aiPolishEnabled: boolean;
  shortcut: string;
  transcriptionProvider: TranscriptionProvider;
  ensembleEnabled: boolean;  // NEW
  dictionary: DictionaryEntry[];
  history: HistoryEntry[];
  loading: boolean;
  // ... actions
}
```

3. **Update initial state:**
```typescript
ensembleEnabled: false,
```

4. **Update loadSettings:**
```typescript
set({
  aiPolishEnabled: settings.ai_polish_enabled,
  shortcut: settings.shortcut || 'Alt+Space',
  transcriptionProvider: settings.transcription_provider || 'gladia',
  ensembleEnabled: settings.ensemble_enabled ?? false,  // NEW
});
```

5. **Update saveSettings:**
```typescript
const currentSettings: Settings = {
  ai_polish_enabled: get().aiPolishEnabled,
  shortcut: get().shortcut,
  transcription_provider: get().transcriptionProvider,
  ensemble_enabled: get().ensembleEnabled,  // NEW
};
```

And in the set() call:
```typescript
set({
  aiPolishEnabled: newSettings.ai_polish_enabled,
  shortcut: newSettings.shortcut,
  transcriptionProvider: newSettings.transcription_provider,
  ensembleEnabled: newSettings.ensemble_enabled,  // NEW
});
```

6. **Update resetSettings:**
```typescript
set({
  aiPolishEnabled: true,
  shortcut: 'Alt+Space',
  transcriptionProvider: 'gladia',
  ensembleEnabled: false,  // NEW
});
```
  </action>
  <verify>
TypeScript compiles without errors: `npm run check` or `npx tsc --noEmit`
  </verify>
  <done>
settings-store.ts updated with:
- Settings interface has ensemble_enabled field
- Store has ensembleEnabled state
- loadSettings loads ensemble_enabled from backend
- saveSettings persists ensemble_enabled to backend
- resetSettings resets to false
  </done>
</task>

<task type="auto">
  <name>Task 2: Add ensemble toggle UI to Settings.tsx</name>
  <files>src/windows/Settings.tsx</files>
  <action>
Update `src/windows/Settings.tsx`:

1. **Add ensembleEnabled to destructured store values:**
```typescript
const {
  aiPolishEnabled,
  shortcut,
  transcriptionProvider,
  ensembleEnabled,  // NEW
  // ... rest
} = useSettingsStore();
```

2. **Add state for tracking available providers:**
```typescript
const [hasOpenAIKey, setHasOpenAIKey] = useState(false);
```

In the useEffect that checks API keys, add:
```typescript
invoke<boolean>('has_api_key').then(setHasOpenAIKey).catch(console.error);
```

3. **Compute available provider count:**
```typescript
// Count configured providers for ensemble
const availableProviders: string[] = [];
if (hasOpenAIKey) availableProviders.push('OpenAI');
if (hasGroqKey) availableProviders.push('Groq');
if (hasGladiaKey) availableProviders.push('Gladia');
const canEnableEnsemble = availableProviders.length >= 2 && hasOpenAIKey;
```

Note: OpenAI is required because fusion uses GPT-4o-mini.

4. **Add handler for ensemble toggle:**
```typescript
const handleEnsembleToggle = async (enabled: boolean) => {
  try {
    await saveSettings({ ensemble_enabled: enabled });
  } catch (error) {
    console.error('Failed to save ensemble setting:', error);
  }
};
```

5. **Add Ensemble Mode toggle UI in Transcription section (after AI Polish toggle):**
```tsx
{/* Ensemble Mode Toggle */}
<div className="flex items-center justify-between mt-6 pt-6 border-t border-gray-200 dark:border-gray-700">
  <div className="flex-1 pr-4">
    <p className="text-gray-900 dark:text-white font-medium">
      Ensemble Mode
    </p>
    <p className="text-sm text-gray-500 dark:text-gray-400 mt-1">
      Use multiple providers for higher accuracy (requires OpenAI + 1 other)
    </p>
    {ensembleEnabled && canEnableEnsemble && (
      <p className="text-xs text-blue-500 dark:text-blue-400 mt-1">
        Active: {availableProviders.join(' + ')}
      </p>
    )}
  </div>
  <Toggle
    enabled={ensembleEnabled}
    onChange={handleEnsembleToggle}
    disabled={loading || !canEnableEnsemble}
  />
</div>

{!canEnableEnsemble && (
  <p className="text-xs text-amber-600 dark:text-amber-400 mt-2">
    {!hasOpenAIKey
      ? 'OpenAI API key required for ensemble fusion'
      : 'Configure at least 2 provider API keys to enable ensemble mode'
    }
  </p>
)}
```

6. **Position:** Place this new section inside the Transcription section, after the AI Polish toggle div but before the closing </section> tag. The border-t class will create visual separation.
  </action>
  <verify>
Run `npm run dev` and open settings window.
Verify:
- Ensemble toggle appears below AI Polish toggle
- Toggle is disabled when < 2 API keys configured
- Toggle is disabled when OpenAI key missing (needed for fusion)
- When enabled, shows active providers
- Warning messages appear when requirements not met
  </verify>
  <done>
Settings.tsx updated with:
- Ensemble Mode toggle in Transcription section
- Toggle disabled when fewer than 2 API keys configured
- Toggle disabled when OpenAI key missing (required for fusion)
- Shows list of active providers when enabled
- Warning messages for missing requirements
  </done>
</task>

</tasks>

<verification>
1. TypeScript compiles: `npm run check` or `npx tsc --noEmit`
2. Settings window shows Ensemble Mode toggle
3. Toggle disabled appropriately based on API key configuration
4. Saving toggle persists to backend settings
5. Loading settings restores ensemble state correctly
</verification>

<success_criteria>
- settings-store.ts has ensembleEnabled state synced with backend
- Settings.tsx shows Ensemble Mode toggle in Transcription section
- Toggle is disabled when requirements not met (< 2 keys or no OpenAI key)
- Active providers displayed when ensemble enabled
- Clear messaging about requirements
</success_criteria>

<output>
After completion, create `.planning/phases/05-ensemble-transcription/05-03-SUMMARY.md`
</output>
